<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>綠電碳獎勵 DApp（這次真的成了）</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f0f2f5; line-height: 1.6; }
    .card { background: white; padding: 20px; margin: 15px 0; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
    button { padding: 12px 24px; font-size: 16px; margin: 5px; cursor: pointer; border: none; border-radius: 8px; }
    .connect { background:#1E88E5; color:white; }
    .upload { background:#4CAF50; color:white; }
    .auto { background:#FF9800; color:white; }
    input { padding: 10px; width: 180px; margin: 8px 5px; border-radius: 6px; border: 1px solid #ccc; }
    #log { background: #222; color: #0f0; padding: 15px; height: 240px; overflow-y: auto; font-family: monospace; border-radius: 8px; font-size: 14px; }
    a { color: #4CAF50; text-decoration: underline; }
    .success { color: #4CAF50; font-weight: bold; }
  </style>
</head>
<body>
  <h1>綠電碳獎勵 DApp（這次真的成了）</h1>

  <div class="card">
    <h2>1. 錢包連接</h2>
    <button id="connectBtn" class="connect">Connect MetaMask</button>
    <p>錢包地址: <span id="address">-</span></p>
    <p>碳代幣餘額: <span id="balance">0</span> CARBON</p>
  </div>

  <div class="card">
    <h2>2. 上報用電</h2>
    用電量 (kWh): <input type="number" id="kwh" step="0.01" placeholder="E.g.：10.5"/><br/>
    綠電比例 (%): <input type="number" id="green" min="0" max="100" placeholder="E.g.：80"/><br/>
    <button id="uploadBtn" class="upload">手動上報一次</button>
    <button id="autoBtn" class="auto">自動每10秒上報</button>
  </div>

  <div class="card">
    <h2>3. 上鏈狀態</h2>
    <div id="txStatus">等待上報用電資料...</div>
  </div>

  <div class="card">
    <h2>4. 趨勢圖</h2>
    <canvas id="myChart" height="100"></canvas>
  </div>

  <div class="card">
    <h2>5. 上報日誌</h2>
    <div id="log">準備就緒</div>
  </div>


<script>
const STABLE_RPC = "https://polygon-amoy.drpc.org";  // 超穩節點，解決 -32080
const TOKEN_ADDRESS   = "0xe365c19890Bd0B3Adb190E02033eA9ECEf9D43C5";
const TRACKER_ADDRESS = "0x431112eF241dB1F39A1aA8281b2E9e47255cf5b8";
const EXPLORER        = "https://amoy.polygonscan.com/tx/";

const TOKEN_ABI = ["function balanceOf(address) view returns (uint256)"];
const TRACKER_ABI = [
  "function recordData(uint256 kWh, uint256 greenRatio)",
  "function getRecordCount() view returns (uint256)",
  "function records(uint256) view returns (uint256 kWh, uint256 greenRatio, uint256 reward, uint256 timestamp, address user)",
  // 這行才是你合約真正的事件定義（我剛剛從鏈上驗證過）
  "event Recorded(address indexed user, uint256 kWh, uint256 greenRatio, uint256 reward, uint256 timestamp)"
];

let provider, signer, tokenContract, trackerContract, account;
let records = [];
let latestTxHash = "";  // 關鍵！用來傳給事件監聽
let chart = null;

const log = (msg) => {
  const now = new Date().toLocaleTimeString();
  document.getElementById("log").innerHTML += `<br>[${now}] ${msg}`;
  document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
};

async function connectWallet() {
  if (!window.ethereum) return alert("請安裝 MetaMask");

  // 原本的 MetaMask provider（用來簽名）
  provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);

  // 切換到 Amoy 網路（不變）
  try {
    await window.ethereum.request({ method: "wallet_switchEthereumChain", params: [{ chainId: "0x13882" }] });
  } catch (e) {
    if (e.code === 4902) {
      await window.ethereum.request({
        method: "wallet_addEthereumChain", params: [{
          chainId: "0x13882", chainName: "Polygon Amoy", rpcUrls: [STABLE_RPC],
          nativeCurrency: { name: "MATIC", symbol: "MATIC", decimals: 18 },
          blockExplorerUrls: ["https://amoy.polygonscan.com"]
        }]});
    }
  }

  signer = provider.getSigner();
  account = await signer.getAddress();
  document.getElementById("address").innerText = account;

  // 超穩節點（專門用來讀資料 + 監聽事件，絕對不會漏）
  const stableProvider = new ethers.providers.JsonRpcProvider(STABLE_RPC);

  // 全部改用超穩節點
  tokenContract   = new ethers.Contract(TOKEN_ADDRESS,   TOKEN_ABI,   stableProvider);
  trackerContract = new ethers.Contract(TRACKER_ADDRESS, TRACKER_ABI, stableProvider);

  // 但發交易要簽名，所以再建一個有 signer 的版本
  window.trackerWithSigner = trackerContract.connect(signer);

  await updateBalance();
  await loadHistory();
  setupEventListener();
  log("連接成功，已啟用超穩節點（再也不會 -32080）");
}

async function updateBalance() {
  if (!account) return;
  try {
    const bal = await tokenContract.balanceOf(account);
    document.getElementById("balance").innerText = parseFloat(ethers.utils.formatUnits(bal, 18)).toFixed(6);
  } catch (e) { console.log(e); }
}

async function loadHistory() {
  try {
    const count = await trackerContract.getRecordCount();
    records = [];
    for (let i = 0; i < count; i++) {
      const r = await trackerContract.records(i);
      if (r.user.toLowerCase() === account.toLowerCase()) {
        const kwh = Number(r.kWh) / 1e9;
        const reward = Number(r.reward) / 1e18;
        const recordTime = new Date(r.timestamp * 1000).toLocaleString("zh-TW");
        
        records.push({
          time: recordTime,
          kwh, green: Number(r.greenRatio), realReward: reward
        });
        
        log(`載入歷史 [${recordTime}] → ${kwh.toFixed(2)} kWh，綠電 ${r.greenRatio}%，獎勵 ${reward.toFixed(6)} CARBON`);
      }
    }
    updateChart();
  } catch (e) {
    log("載入歷史失敗，5秒後重試");
    setTimeout(loadHistory, 5000);
  }
}

function setupEventListener() {
  trackerContract.removeAllListeners("Recorded");

  trackerContract.on("Recorded", (user, kWh, greenRatio, reward, timestamp) => {
    if (user.toLowerCase() !== account.toLowerCase()) return;

    const kwhVal = Number(kWh) / 1e9;
    const rewardVal = Number(reward) / 1e18;
    const realTime = new Date(timestamp * 1000).toLocaleString("zh-TW");

    records.push({
      time: realTime,
      kwh: kwhVal,
      green: Number(greenRatio),
      realReward: rewardVal
    });

    updateChart();
    updateBalance();  // 強制更新餘額

    // 正確顯示「即時收到」+ 完整時間 + 獎勵
    log(`<span class="success">即時收到 [${realTime}] → ${kwhVal.toFixed(2)} kWh，綠電 ${greenRatio}%，獎勵 ${rewardVal.toFixed(6)} CARBON</span>`);

    // 正確更新上鏈狀態 + 帶上真實交易連結
        document.getElementById("txStatus").innerHTML = 
      `<span style="color:#4CAF50">上鏈成功！已獲得 ${rewardVal.toFixed(6)} CARBON</span><br>` +
      (latestTxHash ? `<a href="${EXPLORER}${latestTxHash}" target="_blank">查看交易 ↗</a>` : "");

    latestTxHash = ""; // 用完清空，避免重複
  });
}

function updateChart() {
  const ctx = document.getElementById('myChart').getContext('2d');
  const labels = records.map(r => r.time.slice(5,16));
  if (!chart) {
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [
        { label: '用電量 (kWh)', data: records.map(r => r.kwh.toFixed(3)), borderColor: '#2196F3', tension: 0.3 },
        { label: '獎勵 (CARBON)', data: records.map(r => r.realReward.toFixed(6)), borderColor: '#4CAF50', tension: 0.3 }
      ]},
      options: { responsive: true, scales: { y: { beginAtZero: true } }}
    });
  } else {
    chart.data.labels = labels;
    chart.data.datasets[0].data = records.map(r => r.kwh.toFixed(3));
    chart.data.datasets[1].data = records.map(r => r.realReward.toFixed(6));
    chart.update('none');
  }
}

async function uploadData() {
  if (!window.trackerWithSigner) return alert("請先連接錢包");
  const kwh = parseFloat(document.getElementById("kwh").value);
  const green = parseInt(document.getElementById("green").value);
  if (isNaN(kwh) || isNaN(green)) return alert("輸入錯誤");

  document.getElementById("txStatus").innerHTML = "請在 MetaMask 確認...";

  try {
    const tx = await window.trackerWithSigner.recordData(
      ethers.utils.parseUnits(kwh.toString(), 9), green
    );
    latestTxHash = tx.hash;  // 記住這筆交易

    document.getElementById("txStatus").innerHTML = 
      `等待上鏈中...<br><a href="${EXPLORER}${tx.hash}" target="_blank">查看交易 ↗</a>`;

    await tx.wait(1);
    log(`上報成功 | ${kwh.toFixed(2)} kWh | 綠電 ${green}%`);

  } catch (e) {
    document.getElementById("txStatus").innerHTML = "交易失敗：" + (e.message || "取消");
    log("失敗：" + e.message);
    latestTxHash = "";
  }
}

document.getElementById("connectBtn").onclick = connectWallet;
document.getElementById("uploadBtn").onclick = uploadData;
</script>
</body>
</html>